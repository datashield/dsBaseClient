language: generic
sudo: required
dist: trusty
before_install:
#    - cat /etc/hosts # optionally check the content *before*
    - sudo hostname "$(hostname | cut -c1-63)"
    - sed -e "s/^\\(127\\.0\\.0\\.1.*\\)/\\1 $(hostname | cut -c1-63)/" /etc/hosts | sudo tee /etc/hosts
#    - cat /etc/hosts # optionally check the content *after*
    - curl -OL http://raw.github.com/craigcitro/r-travis/master/scripts/travis-tool.sh
    - chmod 755 ./travis-tool.sh
    - wget -nv https://apt.puppetlabs.com/puppetlabs-release-pc1-trusty.deb
    - sudo dpkg -i puppetlabs-release-pc1-trusty.deb
    - sudo rm -f puppetlabs-release-pc1-trusty.deb
    - sudo apt-get update -qq
    - sudo apt-get install -qq puppet-agent -y
    - sudo apt-get install -qq git -y
    - sudo /opt/puppetlabs/puppet/bin/gem install r10k
    - git clone https://github.com/nparley/datashield.git /tmp/datashield
    - cd /tmp/datashield/puppet/environments/travis && sudo /opt/puppetlabs/puppet/bin/r10k puppetfile install && cd -
    - sudo /opt/puppetlabs/bin/puppet apply /tmp/datashield/puppet/environments/travis/manifests/site.pp --environment travis --environmentpath /tmp/datashield/puppet/environments

install:
    - sudo ./travis-tool.sh install_github jimhester/covr
script:
    - ./travis-tool.sh run_tests

after_failure:
    - ./travis-tool.sh dump_logs
    - sudo cat /var/log/opal/stdout.log

notifications:
  email:
    on_success: change
    on_failure: change

after_success:
    - Rscript -e 'covr::codecov()'

